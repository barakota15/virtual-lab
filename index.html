<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة الكشف عن الجذر الحامضي البصري</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;700&display=swap');
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .reagent-btn {
            background-color: #1e3a8a; /* bg-blue-900 */
            color: #fcd34d; /* text-yellow-400 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .reagent-btn:hover:not(:disabled) {
            background-color: #1e40af; /* bg-blue-800 */
        }
        .reagent-btn:disabled {
            background-color: #9ca3af; /* bg-gray-400 */
            cursor: not-allowed;
            color: #f3f4f6;
        }
        .log-item {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .log-positive {
            background-color: #d1fae5; /* bg-green-100 */
        }
        .log-negative {
            background-color: #fee2e2; /* bg-red-100 */
        }
        .reset-btn {
            background-color: #f97316; /* bg-orange-500 */
            transition: background-color 0.2s;
        }
        .reset-btn:hover {
            background-color: #ea580c; /* bg-orange-600 */
        }
        .action-btn {
            background-color: #38a169; /* bg-emerald-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            font-weight: 500;
            margin-top: 0.5rem;
        }
        .action-btn:hover:not(:disabled) {
            background-color: #2f855a;
        }

        /* Test Tube Styling */
        #test-tube-container {
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 1.5rem;
        }
        #test-tube {
            width: 80px;
            height: 250px;
            background-color: #fff;
            border: 3px solid #6b7280; /* Gray border */
            border-radius: 0 0 40px 40px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse; /* For precipitates */
        }
        #salt-contents {
            width: 100%;
            height: 100%;
            background-color: #f3f4f6; /* Initial salt color (light gray) */
            position: relative;
            transition: all 0.5s ease;
        }

        /* Chemical Effects (Animation/Color Changes) */
        
        /* Precipitates */
        .ppt {
            width: 100%;
            height: 15px; /* Height of the precipitate layer */
            position: absolute;
            bottom: 0;
            opacity: 0.9;
            z-index: 10;
            transition: height 0.3s ease, opacity 0.3s ease;
        }
        .white-ppt { background-color: rgba(255, 255, 255, 0.9); border-top: 1px solid #ccc; }
        .yellow-ppt { background-color: rgba(255, 255, 0, 0.9); border-top: 1px solid #cc0; }
        .dissolved { height: 0 !important; opacity: 0 !important; } /* For solubility test */

        /* Fizzing - Made more prominent */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        @keyframes bubbles {
            0% { background-position: 0 100%; }
            100% { background-position: 0 0; }
        }
        .fizzing {
            animation: bubbles 0.8s linear infinite, shake 0.3s infinite alternate; /* Faster bubbles + shaking */
        }

        /* Fumes/Gas Color */
        .brown-fumes::after {
            content: '';
            position: absolute;
            top: -20px;
            left: 5px;
            right: 5px;
            height: 40px;
            border-radius: 50%;
            background: rgba(139, 69, 19, 0.8); /* Brown/Orange */
        }
        .violet-fumes::after {
            content: '';
            position: absolute;
            top: -20px;
            left: 5px;
            right: 5px;
            height: 40px;
            border-radius: 50%;
            background: rgba(148, 0, 211, 0.8); /* Violet */
        }
        
        /* Specific confirmatory colors */
        .orange-ppt { background-color: #f6ad55; border-top: 300px solid #f6ad55; } /* Initial K2Cr2O7 color */
        .green-ppt { background-color: #6ee7b7; border-top: 300px solid #6ee7b7; } /* Transition to Emerald Green */
        
        /* Ammonia Cloud */
        .ammonia-cloud {
            content: '';
            position: absolute;
            top: -20px;
            left: 5px;
            right: 0px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container max-w-5xl mx-auto p-4 sm:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-900 mb-2">لعبة محاكاة المعمل الكيميائي البصري</h1>
            <p class="text-gray-600">اختبر الكواشف. شاهد التفاعل. حلل الملاحظات. خمن الملح.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Panel 1: Reagent Controls -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">إضافة الكواشف</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-blue-700">كواشف المجموعات (الملح الصلب)</h3>
                    <div class="flex flex-col gap-3">
                        <button id="reagent-dil-hcl" data-reagent-key="DIL_HCL" class="reagent-btn text-right">حمض الهيدروكلوريك المخفف (dil HCl)</button>
                        <button id="reagent-conc-h2so4" data-reagent-key="CONC_H2SO4" class="reagent-btn text-right">حمض الكبريتيك المركز (conc H₂SO₄)</button>
                        <button id="reagent-bacl2-group" data-reagent-key="BACL2" class="reagent-btn text-right">كلوريد الباريوم (BaCl₂)</button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-blue-700">كواشف تأكيدية (محلول الملح)</h3>
                    <div class="flex flex-col gap-3">
                        <button id="reagent-mgso4" data-reagent-key="MGSO4" class="reagent-btn text-right">كبريتات المغنيسيوم (MgSO₄)</button>
                        <button id="reagent-pba" data-reagent-key="PBA" class="reagent-btn text-right">خلات الرصاص (Pb(CH₃COO)₂)</button>
                        <button id="reagent-agno3" data-reagent-key="AGNO3" class="reagent-btn text-right">نترات الفضة (AgNO₃)</button>
                    </div>
                </div>

                 <div class="mt-8 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-3 text-red-600">إجراءات إضافية</h3>
                    <div class="flex flex-col gap-2">
                        <button id="action-k2cr2o7" data-action-key="K2CR2O7" class="action-btn !bg-orange-600 hover:!bg-orange-700 text-right" disabled>أضف ثاني كرومات البوتاسيوم (K<sub>2</sub>Cr<sub>2</sub>O<sub>7</sub>)</button>
                        <button id="action-ammonia" data-action-key="AMMONIA" class="action-btn !bg-gray-700 hover:!bg-gray-800 text-right" disabled>عرّض ساق الأمونيا (للكشف عن HCl)</button>
                        <button id="action-solubility" data-action-key="SOLUBILITY" class="action-btn !bg-blue-600 hover:!bg-blue-700 text-right" disabled>اختبر الذوبانية في dil HCl</button>
                        <button id="action-heat" data-action-key="HEAT" class="action-btn !bg-red-500 hover:!bg-red-600 text-right" disabled>سخّن (لتأكيد HCO₃)</button>
                    </div>
                </div>
            </div>

            <!-- Panel 2: Test Tube Visualization -->
            <div class="lg:col-span-1 bg-gray-100 p-6 rounded-xl shadow-inner flex flex-col items-center">
                <h2 class="text-xl font-bold mb-4 text-gray-700">أنبوب الاختبار</h2>
                <div id="test-tube-container">
                    <div id="test-tube">
                        <div id="salt-contents">
                            <!-- Visual effects will be added here -->
                        </div>
                    </div>
                </div>
                <p class="text-lg font-semibold text-center mt-4" id="salt-status">ملح صلب مجهول جاهز للاختبار.</p>
                <div class="mt-4 p-2 bg-yellow-100 border border-yellow-300 rounded-md text-sm text-yellow-800 hidden" id="initial-result"></div>
            </div>

            <!-- Panel 3: Log and Guess -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full flex flex-col">
                <h2 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">سجل الملاحظات والتخمين</h2>
                
                <div id="observation-log" class="bg-gray-50 p-3 rounded-lg flex-grow h-48 overflow-y-auto border border-gray-200 mb-4">
                    <p class="text-gray-400 text-center">لا توجد ملاحظات بعد.</p>
                </div>

                <!-- Guess Section -->
                <div id="guess-section" class="pt-4 border-t border-gray-200 mt-auto">
                    <h3 class="text-xl font-bold mb-3 text-blue-900">تخمين الجذر الحامضي</h3>
                    <select id="salt-guess" class="w-full p-2 border border-gray-300 rounded-md mb-3 text-gray-700">
                        <!-- Options filled by JS -->
                    </select>
                    <button id="guess-btn" class="w-full p-2 bg-green-600 text-white rounded-md font-bold hover:bg-green-700 transition-colors" disabled>خمن الملح</button>
                    <div id="guess-result" class="mt-3 p-3 text-center rounded-md font-semibold hidden"></div>
                </div>
                <div class="text-center mt-4 flex gap-4">
                    <button id="reset-tube-btn" class="p-3 text-gray-700 bg-gray-200 rounded-md font-bold w-1/2 hover:bg-gray-300 transition-colors">مسح الأنبوبة وإعادة الاختبار</button>
                    <button id="reset-btn" class="reset-btn p-3 text-white rounded-md font-bold w-1/2">إعادة اللعبة بالكامل</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const REAGENTS = {
            DIL_HCL: { name: "حمض الهيدروكلوريك المخفف (dil HCl)", type: "group", target: "group1" },
            CONC_H2SO4: { name: "حمض الكبريتيك المركز (conc H₂SO₄)", type: "group", target: "group2" },
            BACL2: { name: "كلوريد الباريوم (BaCl₂)", type: "group", target: "group3" },
            MGSO4: { name: "كبريتات المغنيسيوم (MgSO₄)", type: "confirmatory" },
            PBA: { name: "خلات الرصاص (Pb(CH₃COO)₂)", type: "confirmatory" },
            AGNO3: { name: "نترات الفضة (AgNO₃)", type: "confirmatory" }
        };

        const SALTS = {
            "CO3--": {
                name: "كربونات", group: 1, ion: "CO₃²⁻",
                DIL_HCL: { obs: "فوران وغاز CO₂.", effect: "fizzing", nextAction: null }, 
                MGSO4: { obs: "راسب أبيض على البارد (White ppt on cold) ⚪", effect: "white-ppt" }
            },
            "HCO3-": {
                name: "بيكربونات", group: 1, ion: "HCO₃⁻",
                DIL_HCL: { obs: "فوران وغاز CO₂.", effect: "fizzing", nextAction: null },
                MGSO4: { obs: "لا يتكون راسب على البارد.", effect: "none", nextAction: "HEAT" }
            },
            "NO2-": {
                name: "نتريت", group: 1, ion: "NO₂⁻",
                DIL_HCL: { obs: "تصاعد أبخرة بنية على فوهة الأنبوبة.", effect: "brown-fumes", nextAction: null },
                AGNO3: { obs: "راسب أبيض (White ppt) ⚪", effect: "white-ppt" }
            },
            "SO3--": {
                name: "كبريتيت", group: 1, ion: "SO₃²⁻",
                DIL_HCL: { obs: "تصاعد غاز SO₂.", effect: "1", nextAction: "K2CR2O7" },
                PBA: { obs: "راسب أبيض (White ppt) ⚪", effect: "white-ppt" }
            },
            "Cl-": {
                name: "كلوريد", group: 2, ion: "Cl⁻",
                DIL_HCL: { obs: "سلبية (-ve)", effect: "none" },
                CONC_H2SO4: { obs: "تصاعد غاز HCl.", effect: "1", nextAction: "AMMONIA" },
                PBA: { obs: "راسب أبيض (White ppt) ⚪", effect: "white-ppt" },
                AGNO3: { obs: "راسب أبيض (White ppt) ⚪", effect: "white-ppt" }
            },
            "I-": {
                name: "يوديد", group: 2, ion: "I⁻",
                DIL_HCL: { obs: "سلبية (-ve)", effect: "none" },
                CONC_H2SO4: { obs: "تصاعد أبخرة بنفسجية داكنة (I₂) 🟣", effect: "violet-fumes", nextAction: null },
                PBA: { obs: "راسب أبيض (White ppt) ⚪", effect: "white-ppt" },
                AGNO3: { obs: "راسب أصفر 🟡", effect: "yellow-ppt" }
            },
            "SO4--": {
                name: "كبريتات", group: 3, ion: "SO₄²⁻",
                DIL_HCL: { obs: "سلبية (-ve)", effect: "none" },
                CONC_H2SO4: { obs: "سلبية (-ve)", effect: "none" },
                BACL2: { obs: "تكون راسب أبيض.", effect: "white-ppt", nextAction: "SOLUBILITY" },
                AGNO3: { obs: "راسب أبيض (White ppt) ⚪", effect: "white-ppt" }
            },
            "PO4---": {
                name: "فوسفات", group: 3, ion: "PO₄³⁻",
                DIL_HCL: { obs: "سلبية (-ve)", effect: "none" },
                CONC_H2SO4: { obs: "سلبية (-ve)", effect: "none" },
                BACL2: { obs: "تكون راسب أبيض.", effect: "white-ppt", nextAction: "SOLUBILITY" },
                AGNO3: { obs: "راسب أصفر 🟡", effect: "yellow-ppt" }
            }
        };

        const SALTS_ARRAY = Object.keys(SALTS);
        let currentSaltKey = null;
        let log = [];
        let isPptPresent = false;
        let isTestActive = false; // New state to enforce procedural flow

        const elements = {
            status: document.getElementById('salt-status'),
            tube: document.getElementById('test-tube'),
            tubeContents: document.getElementById('salt-contents'),
            log: document.getElementById('observation-log'),
            guessSelect: document.getElementById('salt-guess'),
            guessBtn: document.getElementById('guess-btn'),
            guessResult: document.getElementById('guess-result'),
            reagentBtns: document.querySelectorAll('.reagent-btn'),
            resetTubeBtn: document.getElementById('reset-tube-btn'),
            actionBtns: {
                K2CR2O7: document.getElementById('action-k2cr2o7'),
                AMMONIA: document.getElementById('action-ammonia'),
                SOLUBILITY: document.getElementById('action-solubility'),
                HEAT: document.getElementById('action-heat')
            }
        };
        
        function disableAllActions() {
            Object.values(elements.actionBtns).forEach(btn => btn.disabled = true);
        }

        function disableAllReagents() {
            elements.reagentBtns.forEach(btn => btn.disabled = true);
        }

        function enableAllReagents() {
            elements.reagentBtns.forEach(btn => btn.disabled = false);
        }

        function clearVisuals() {
            elements.tubeContents.className = 'bg-gray-200';
            elements.tubeContents.innerHTML = '';
            elements.tube.classList.remove('fumes-active', 'cloud-active');
            isPptPresent = false;
        }

        function startNewGame() {
            //currentSaltKey = SALTS_ARRAY[Math.floor(Math.random() * SALTS_ARRAY.length)];
            currentSaltKey = SALTS_ARRAY[4];
			log.length = 0; 
            isTestActive = false;
            
            clearVisuals();
            disableAllActions();
            enableAllReagents();

            elements.status.innerHTML = 'ملح صلب مجهول جاهز للاختبار.';
            elements.log.innerHTML = '<p class="text-gray-400 text-center">لا توجد ملاحظات بعد.</p>';
            elements.guessBtn.disabled = false;
            elements.guessResult.classList.add('hidden');
            
            elements.guessSelect.innerHTML = '<option value="">-- اختر تخمينك --</option>';
            const shuffledSalts = [...SALTS_ARRAY].sort(() => Math.random() - 0.5);
            shuffledSalts.forEach(key => {
                const option = document.createElement('option');
                option.value = key; // Use the salt key (e.g., "CO3--") as the value
                option.textContent = SALTS[key].name + ' (' + SALTS[key].ion + ')';
                elements.guessSelect.appendChild(option);
            });
        }

        // Function to reset only the tube visuals and actions (keeping the salt and log)
        function resetTube() {
            clearVisuals();
            disableAllActions();
            enableAllReagents();
            isTestActive = false;
            elements.status.innerHTML = 'الأنبوبة نظيفة. استمر في إضافة الكواشف.';
        }

        function getReaction(saltKey, reagentKey) {
            const salt = SALTS[saltKey];
            let reaction = salt[reagentKey];

            if (reaction) return reaction;

            // Default negative result logic
            const saltGroup = salt.group;
            let obsText = "سلبية (-ve)";

            if (reagentKey === 'DIL_HCL' && saltGroup > 1) {
                obsText = "سلبية (-ve). لا ينتمي للمجموعة الأولى.";
            } else if (reagentKey === 'CONC_H2SO4' && saltGroup > 2) {
                obsText = "سلبية (-ve). لا ينتمي للمجموعة الثانية.";
            } else if (reagentKey === 'BACL2' && saltGroup < 3) {
                obsText = "لا يوجد تفاعل مميز.";
            } else if (REAGENTS[reagentKey].type === 'confirmatory') {
                obsText = "لا يوجد تفاعل مميز أو نتيجة سلبية (-ve)";
            }
            
            return { obs: obsText, effect: "none" };
        }

        function applyVisualEffect(effect) {
            elements.tubeContents.classList.remove('fizzing', 'brown-fumes', 'violet-fumes', 'green-ppt', 'orange-ppt');
            elements.tubeContents.classList.add('bg-gray-200');

            if (effect === 'none') {
                return;
            }
            
            elements.tubeContents.classList.add(effect);

            // Gases/Fumes
            if (effect.includes('fumes')) {
                 elements.tubeContents.style.height = '100%';
            }
            
            // Solution color change
            if (effect.includes('solution')) {
                 elements.tubeContents.style.height = '100%';
            }

            // Precipitates
            if (effect.includes('ppt')) {
                if (!isPptPresent) {
                    const pptLayer = document.createElement('div');
                    pptLayer.className = `ppt ${effect}`;
                    elements.tubeContents.appendChild(pptLayer);
                    isPptPresent = true;
                }
            }
        }
        
        function logObservation(reagentName, observationText, logType) {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${logType}`;
            logItem.innerHTML = `<b>${reagentName}:</b> ${observationText}`;
            
            if (log.length === 0) {
                elements.log.innerHTML = '';
            }
            elements.log.prepend(logItem); 
            log.push({ reagent: reagentName, result: observationText });
            elements.log.scrollTop = 0;
        }

        // --- Core Reagent Click Handler ---
        elements.reagentBtns.forEach(btn => {
            btn.addEventListener('click', (event) => {
                if (isTestActive) return; // Prevent new test without reset
                
                const reagentKey = event.target.dataset.reagentKey;
                const reagentName = REAGENTS[reagentKey].name;
                const reaction = getReaction(currentSaltKey, reagentKey);
                
                // Set procedural state
                isTestActive = true; 
                disableAllReagents(); // Disable reagents after first test
                
                // Clear previous visuals and reset actions
                clearVisuals();
                disableAllActions();
                
                // Show visual effect
                applyVisualEffect(reaction.effect);

                // Determine log type and update status
                const isPositive = !reaction.obs.includes("سلبية (-ve)") && reaction.effect !== 'none';
                const logType = isPositive ? 'log-positive' : 'log-negative';
                elements.status.innerHTML = isPositive ? 'الملاحظة إيجابية. انظر إلى الأنبوب.' : 'الملاحظة سلبية. استمر في الاختبار أو خمن.';

                // Log observation (bypasses direct observation for complex tests like SO3-- and Cl-)
                let finalObs = reaction.obs;
                if (reaction.nextAction) {
                    // For complex tests, log only the primary observation
                     if (reagentKey === 'DIL_HCL' && currentSaltKey === 'SO3--') {
                        finalObs = 'تصاعد غاز SO₂. يحتاج إلى كاشف إضافي للتأكيد.';
                    } else if (reagentKey === 'CONC_H2SO4' && currentSaltKey === 'Cl-') {
                        finalObs = 'تصاعد غاز HCl. يحتاج إلى تعريض للأمونيا للتأكيد.';
                    }
                }
                logObservation(reagentName, finalObs, logType);
                
                // Enable next specific action if defined in SALTS data
                if (reaction.nextAction) {
                    const nextActionBtn = elements.actionBtns[reaction.nextAction];
                    if (nextActionBtn) nextActionBtn.disabled = false;
                }

                // Special handling for BaCl2 ppt to enable solubility test immediately
                if (reagentKey === 'BACL2' && (currentSaltKey === 'SO4--' || currentSaltKey === 'PO4---')) {
                    elements.actionBtns.SOLUBILITY.disabled = false;
                }
                
                // Special handling for MgSO4 non-ppt to enable heat action (for HCO3-)
                if (reagentKey === 'MGSO4' && currentSaltKey === 'HCO3-') {
                    elements.actionBtns.HEAT.disabled = false;
                }

                elements.guessBtn.disabled = false;
            });
        });

        // --- Action Buttons Handlers (K2Cr2O7, Ammonia, Solubility, Heat) ---

        // K2Cr2O7 (Confirmatory for SO3--)
        elements.actionBtns.K2CR2O7.addEventListener('click', () => {
            disableAllActions();
            const reagentName = "ثاني كرومات البوتاسيوم (K₂Cr₂O₇)";
            let obsText;

            if (currentSaltKey === 'SO3--') {
                // Visual sequence: Orange -> Green (slow transition)
                elements.tubeContents.classList.add('orange-ppt');
                elements.status.innerHTML = 'يتم إضافة كاشف ثاني كرومات البوتاسيوم...';
                
                setTimeout(() => {
                    // Start slow transition
                    elements.tubeContents.classList.remove('orange-ppt');
                    elements.tubeContents.classList.add('green-ppt');
                    obsText = "تغير لون المحلول من البرتقالي إلى <b>الأخضر</b>.";
                    logObservation(reagentName, obsText, 'log-positive');
                    elements.status.innerHTML = 'تم تسجيل الملاحظة التأكيدية.';
                }, 2000); // Wait 1 second before turning green (simulating reaction time)
            } else {
                obsText = "لا يوجد تغيير في اللون. نتيجة سلبية.";
                logObservation(reagentName, obsText, 'log-negative');
                elements.status.innerHTML = 'تم تسجيل الملاحظة التأكيدية.';
            }
        });

        // Ammonia (Confirmatory for Cl-)
        elements.actionBtns.AMMONIA.addEventListener('click', () => {
            disableAllActions();
            const reagentName = "تعريض لساق الأمونيا";
            let obsText;

            if (currentSaltKey === 'Cl-') {
                // Insert cloud visual
                applyVisualEffect('ammonia-cloud');
				obsText = "تكون <b>سحب بيضاء</b> كثيفة.";
                logObservation(reagentName, obsText, 'log-positive');
                // Remove cloud after logging (realism: cloud dissipates)
                setTimeout(() => {
                    const cloud = document.getElementById('ammonia-cloud');
                    if (cloud) cloud.remove();
                }, 1500);
            } else {
                obsText = "لا يوجد سحب بيضاء. نتيجة سلبية.";
                logObservation(reagentName, obsText, 'log-negative');
            }
            elements.status.innerHTML = 'تم تسجيل الملاحظة التأكيدية.';
        });

        // Heat (Confirmatory for HCO3-)
        elements.actionBtns.HEAT.addEventListener('click', () => {
            disableAllActions();
            const reagentName = "تسخين/غلي المحلول";
            let obsText;

            if (currentSaltKey === 'HCO3-') {
                applyVisualEffect('white-ppt');
                obsText = "تكون <b>راسب أبيض</b> بعد التسخين.";
                logObservation(reagentName, obsText, 'log-positive');
            } else if (currentSaltKey === 'CO3--') {
                obsText = "راسب أبيض موجود بالفعل ولم يتغير.";
                logObservation(reagentName, obsText, 'log-negative');
            } else {
                obsText = "لا يوجد تغيير ملحوظ. نتيجة سلبية.";
                logObservation(reagentName, obsText, 'log-negative');
            }
            elements.status.innerHTML = 'تم تسجيل الملاحظة التأكيدية.';
        });

        // Solubility Test (SO4-- vs PO4---)
        elements.actionBtns.SOLUBILITY.addEventListener('click', () => {
            elements.actionBtns.SOLUBILITY.disabled = true;
            const reagentName = "اختبار الذوبانية في dil HCl";
            const pptLayer = elements.tubeContents.querySelector('.ppt');
            let obsText;

            if (currentSaltKey === 'PO4---') {
                if (pptLayer) pptLayer.classList.add('dissolved');
                isPptPresent = false; // The ppt is gone
                obsText = "الراسب الأبيض <b>ذاب</b> في dil HCl.";
                logObservation(reagentName, obsText, 'log-positive');
            } else if (currentSaltKey === 'SO4--') {
                if (pptLayer) pptLayer.classList.remove('dissolved');
                obsText = "الراسب الأبيض <b>لم يذب</b> في dil HCl.";
                logObservation(reagentName, obsText, 'log-positive');
            } else {
                obsText = "لا يوجد راسب لتجربة الذوبانية. خطأ في التسلسل.";
                logObservation(reagentName, obsText, 'log-negative');
            }
            elements.status.innerHTML = 'تم تسجيل الملاحظة النهائية للراسب.';
        });

        function handleGuess() {
            const userGuessKey = elements.guessSelect.value;
            const correctSalt = SALTS[currentSaltKey];
            
            elements.guessResult.classList.remove('hidden');
            
            if (userGuessKey === currentSaltKey) { // FIX: Compare userGuessKey (e.g., "CO3--") to currentSaltKey (e.g., "CO3--")
                elements.guessResult.className = 'mt-3 p-3 text-center rounded-md font-bold bg-green-600 text-white';
                elements.guessResult.textContent = `🎉 تهانينا! الإجابة صحيحة. الملح هو ${correctSalt.name} (${correctSalt.ion}).`;
                elements.reagentBtns.forEach(btn => btn.disabled = true);
                disableAllActions();
                elements.guessBtn.disabled = true;
                elements.status.innerHTML = 'تم الكشف عن الملح بنجاح.';
            } else {
                elements.guessResult.className = 'mt-3 p-3 text-center rounded-md font-bold bg-red-600 text-white';
                elements.guessResult.textContent = `❌ تخمين خاطئ. الملح الصحيح كان: ${correctSalt.name} (${correctSalt.ion}).`; // Show the correct answer
                elements.reagentBtns.forEach(btn => btn.disabled = true);
                disableAllActions();
                elements.guessBtn.disabled = true;
                elements.status.innerHTML = 'انتهت اللعبة. أعد البدء للمحاولة مرة أخرى.';
            }
        }

        // Attach listeners
        document.getElementById('reset-btn').addEventListener('click', startNewGame);
        document.getElementById('reset-tube-btn').addEventListener('click', resetTube);
        elements.guessBtn.addEventListener('click', handleGuess);
        
        // Initialize the game
        startNewGame();
    </script>

</body>
</html>
