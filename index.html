<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ø¬Ø°Ø± Ø§Ù„Ø­Ø§Ù…Ø¶ÙŠ Ø§Ù„Ø¨ØµØ±ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@400;700&display=swap');
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background-color: #f9fafb; /* bg-gray-50 */
        }
        .reagent-btn {
            background-color: #1e3a8a; /* bg-blue-900 */
            color: #fcd34d; /* text-yellow-400 */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        .reagent-btn:hover:not(:disabled) {
            background-color: #1e40af; /* bg-blue-800 */
        }
        .reagent-btn:disabled {
            background-color: #9ca3af; /* bg-gray-400 */
            cursor: not-allowed;
            color: #f3f4f6;
        }
        .log-item {
            padding: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .log-positive {
            background-color: #d1fae5; /* bg-green-100 */
        }
        .log-negative {
            background-color: #fee2e2; /* bg-red-100 */
        }
        .reset-btn {
            background-color: #f97316; /* bg-orange-500 */
            transition: background-color 0.2s;
        }
        .reset-btn:hover {
            background-color: #ea580c; /* bg-orange-600 */
        }
        .action-btn {
            background-color: #38a169; /* bg-emerald-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            font-weight: 500;
            margin-top: 0.5rem;
        }
        .action-btn:hover:not(:disabled) {
            background-color: #2f855a;
        }

        /* Test Tube Styling */
        #test-tube-container {
            width: 100%;
            height: 300px;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin-bottom: 1.5rem;
        }
        #test-tube {
            width: 80px;
            height: 250px;
            background-color: #fff;
            border: 3px solid #6b7280; /* Gray border */
            border-radius: 0 0 40px 40px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse; /* For precipitates */
        }
        #salt-contents {
            width: 100%;
            height: 100%;
            background-color: #f3f4f6; /* Initial salt color (light gray) */
            position: relative;
            transition: all 0.5s ease;
        }

        /* Chemical Effects (Animation/Color Changes) */
        
        /* Precipitates */
        .ppt {
            width: 100%;
            height: 15px; /* Height of the precipitate layer */
            position: absolute;
            bottom: 0;
            opacity: 0.9;
            z-index: 10;
            transition: height 0.3s ease, opacity 0.3s ease;
        }
        .white-ppt { background-color: rgba(255, 255, 255, 0.9); border-top: 1px solid #ccc; }
        .yellow-ppt { background-color: rgba(255, 255, 0, 0.9); border-top: 1px solid #cc0; }
        .dissolved { height: 0 !important; opacity: 0 !important; } /* For solubility test */

        /* Fizzing - Made more prominent */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }
        @keyframes bubbles {
            0% { background-position: 0 100%; }
            100% { background-position: 0 0; }
        }
        .fizzing {
            animation: bubbles 0.8s linear infinite, shake 0.3s infinite alternate; /* Faster bubbles + shaking */
        }

        /* Fumes/Gas Color */
        .brown-fumes::after {
            content: '';
            position: absolute;
            top: -20px;
            left: 5px;
            right: 5px;
            height: 40px;
            border-radius: 50%;
            background: rgba(139, 69, 19, 0.8); /* Brown/Orange */
        }
        .violet-fumes::after {
            content: '';
            position: absolute;
            top: -20px;
            left: 5px;
            right: 5px;
            height: 40px;
            border-radius: 50%;
            background: rgba(148, 0, 211, 0.8); /* Violet */
        }
        
        /* Specific confirmatory colors */
        .orange-ppt { background-color: #f6ad55; border-top: 300px solid #f6ad55; } /* Initial K2Cr2O7 color */
        .green-ppt { background-color: #6ee7b7; border-top: 300px solid #6ee7b7; } /* Transition to Emerald Green */
        
        /* Ammonia Cloud */
        .ammonia-cloud {
            content: '';
            position: absolute;
            top: -20px;
            left: 5px;
            right: 0px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
        }
    </style>
</head>
<body class="text-gray-800">

    <div class="container max-w-5xl mx-auto p-4 sm:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-extrabold text-blue-900 mb-2">Ù„Ø¹Ø¨Ø© Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ù…Ø¹Ù…Ù„ Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠ Ø§Ù„Ø¨ØµØ±ÙŠ</h1>
            <p class="text-gray-600">Ø§Ø®ØªØ¨Ø± Ø§Ù„ÙƒÙˆØ§Ø´Ù. Ø´Ø§Ù‡Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„. Ø­Ù„Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª. Ø®Ù…Ù† Ø§Ù„Ù…Ù„Ø­.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Panel 1: Reagent Controls -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ§Ø´Ù</h2>
                
                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-blue-700">ÙƒÙˆØ§Ø´Ù Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª (Ø§Ù„Ù…Ù„Ø­ Ø§Ù„ØµÙ„Ø¨)</h3>
                    <div class="flex flex-col gap-3">
                        <button id="reagent-dil-hcl" data-reagent-key="DIL_HCL" class="reagent-btn text-right">Ø­Ù…Ø¶ Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆÙƒÙ„ÙˆØ±ÙŠÙƒ Ø§Ù„Ù…Ø®ÙÙ (dil HCl)</button>
                        <button id="reagent-conc-h2so4" data-reagent-key="CONC_H2SO4" class="reagent-btn text-right">Ø­Ù…Ø¶ Ø§Ù„ÙƒØ¨Ø±ÙŠØªÙŠÙƒ Ø§Ù„Ù…Ø±ÙƒØ² (conc Hâ‚‚SOâ‚„)</button>
                        <button id="reagent-bacl2-group" data-reagent-key="BACL2" class="reagent-btn text-right">ÙƒÙ„ÙˆØ±ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙŠÙˆÙ… (BaClâ‚‚)</button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-semibold mb-3 text-blue-700">ÙƒÙˆØ§Ø´Ù ØªØ£ÙƒÙŠØ¯ÙŠØ© (Ù…Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù„Ø­)</h3>
                    <div class="flex flex-col gap-3">
                        <button id="reagent-mgso4" data-reagent-key="MGSO4" class="reagent-btn text-right">ÙƒØ¨Ø±ÙŠØªØ§Øª Ø§Ù„Ù…ØºÙ†ÙŠØ³ÙŠÙˆÙ… (MgSOâ‚„)</button>
                        <button id="reagent-pba" data-reagent-key="PBA" class="reagent-btn text-right">Ø®Ù„Ø§Øª Ø§Ù„Ø±ØµØ§Øµ (Pb(CHâ‚ƒCOO)â‚‚)</button>
                        <button id="reagent-agno3" data-reagent-key="AGNO3" class="reagent-btn text-right">Ù†ØªØ±Ø§Øª Ø§Ù„ÙØ¶Ø© (AgNOâ‚ƒ)</button>
                    </div>
                </div>

                 <div class="mt-8 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-3 text-red-600">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</h3>
                    <div class="flex flex-col gap-2">
                        <button id="action-k2cr2o7" data-action-key="K2CR2O7" class="action-btn !bg-orange-600 hover:!bg-orange-700 text-right" disabled>Ø£Ø¶Ù Ø«Ø§Ù†ÙŠ ÙƒØ±ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (K<sub>2</sub>Cr<sub>2</sub>O<sub>7</sub>)</button>
                        <button id="action-ammonia" data-action-key="AMMONIA" class="action-btn !bg-gray-700 hover:!bg-gray-800 text-right" disabled>Ø¹Ø±Ù‘Ø¶ Ø³Ø§Ù‚ Ø§Ù„Ø£Ù…ÙˆÙ†ÙŠØ§ (Ù„Ù„ÙƒØ´Ù Ø¹Ù† HCl)</button>
                        <button id="action-solubility" data-action-key="SOLUBILITY" class="action-btn !bg-blue-600 hover:!bg-blue-700 text-right" disabled>Ø§Ø®ØªØ¨Ø± Ø§Ù„Ø°ÙˆØ¨Ø§Ù†ÙŠØ© ÙÙŠ dil HCl</button>
                        <button id="action-heat" data-action-key="HEAT" class="action-btn !bg-red-500 hover:!bg-red-600 text-right" disabled>Ø³Ø®Ù‘Ù† (Ù„ØªØ£ÙƒÙŠØ¯ HCOâ‚ƒ)</button>
                    </div>
                </div>
            </div>

            <!-- Panel 2: Test Tube Visualization -->
            <div class="lg:col-span-1 bg-gray-100 p-6 rounded-xl shadow-inner flex flex-col items-center">
                <h2 class="text-xl font-bold mb-4 text-gray-700">Ø£Ù†Ø¨ÙˆØ¨ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h2>
                <div id="test-tube-container">
                    <div id="test-tube">
                        <div id="salt-contents">
                            <!-- Visual effects will be added here -->
                        </div>
                    </div>
                </div>
                <p class="text-lg font-semibold text-center mt-4" id="salt-status">Ù…Ù„Ø­ ØµÙ„Ø¨ Ù…Ø¬Ù‡ÙˆÙ„ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±.</p>
                <div class="mt-4 p-2 bg-yellow-100 border border-yellow-300 rounded-md text-sm text-yellow-800 hidden" id="initial-result"></div>
            </div>

            <!-- Panel 3: Log and Guess -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-full flex flex-col">
                <h2 class="text-xl font-bold border-b pb-2 mb-4 text-gray-700">Ø³Ø¬Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØªØ®Ù…ÙŠÙ†</h2>
                
                <div id="observation-log" class="bg-gray-50 p-3 rounded-lg flex-grow h-48 overflow-y-auto border border-gray-200 mb-4">
                    <p class="text-gray-400 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯.</p>
                </div>

                <!-- Guess Section -->
                <div id="guess-section" class="pt-4 border-t border-gray-200 mt-auto">
                    <h3 class="text-xl font-bold mb-3 text-blue-900">ØªØ®Ù…ÙŠÙ† Ø§Ù„Ø¬Ø°Ø± Ø§Ù„Ø­Ø§Ù…Ø¶ÙŠ</h3>
                    <select id="salt-guess" class="w-full p-2 border border-gray-300 rounded-md mb-3 text-gray-700">
                        <!-- Options filled by JS -->
                    </select>
                    <button id="guess-btn" class="w-full p-2 bg-green-600 text-white rounded-md font-bold hover:bg-green-700 transition-colors" disabled>Ø®Ù…Ù† Ø§Ù„Ù…Ù„Ø­</button>
                    <div id="guess-result" class="mt-3 p-3 text-center rounded-md font-semibold hidden"></div>
                </div>
                <div class="text-center mt-4 flex gap-4">
                    <button id="reset-tube-btn" class="p-3 text-gray-700 bg-gray-200 rounded-md font-bold w-1/2 hover:bg-gray-300 transition-colors">Ù…Ø³Ø­ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
                    <button id="reset-btn" class="reset-btn p-3 text-white rounded-md font-bold w-1/2">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        const REAGENTS = {
            DIL_HCL: { name: "Ø­Ù…Ø¶ Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆÙƒÙ„ÙˆØ±ÙŠÙƒ Ø§Ù„Ù…Ø®ÙÙ (dil HCl)", type: "group", target: "group1" },
            CONC_H2SO4: { name: "Ø­Ù…Ø¶ Ø§Ù„ÙƒØ¨Ø±ÙŠØªÙŠÙƒ Ø§Ù„Ù…Ø±ÙƒØ² (conc Hâ‚‚SOâ‚„)", type: "group", target: "group2" },
            BACL2: { name: "ÙƒÙ„ÙˆØ±ÙŠØ¯ Ø§Ù„Ø¨Ø§Ø±ÙŠÙˆÙ… (BaClâ‚‚)", type: "group", target: "group3" },
            MGSO4: { name: "ÙƒØ¨Ø±ÙŠØªØ§Øª Ø§Ù„Ù…ØºÙ†ÙŠØ³ÙŠÙˆÙ… (MgSOâ‚„)", type: "confirmatory" },
            PBA: { name: "Ø®Ù„Ø§Øª Ø§Ù„Ø±ØµØ§Øµ (Pb(CHâ‚ƒCOO)â‚‚)", type: "confirmatory" },
            AGNO3: { name: "Ù†ØªØ±Ø§Øª Ø§Ù„ÙØ¶Ø© (AgNOâ‚ƒ)", type: "confirmatory" }
        };

        const SALTS = {
            "CO3--": {
                name: "ÙƒØ±Ø¨ÙˆÙ†Ø§Øª", group: 1, ion: "COâ‚ƒÂ²â»",
                DIL_HCL: { obs: "ÙÙˆØ±Ø§Ù† ÙˆØºØ§Ø² COâ‚‚.", effect: "fizzing", nextAction: null }, 
                MGSO4: { obs: "Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±Ø¯ (White ppt on cold) âšª", effect: "white-ppt" }
            },
            "HCO3-": {
                name: "Ø¨ÙŠÙƒØ±Ø¨ÙˆÙ†Ø§Øª", group: 1, ion: "HCOâ‚ƒâ»",
                DIL_HCL: { obs: "ÙÙˆØ±Ø§Ù† ÙˆØºØ§Ø² COâ‚‚.", effect: "fizzing", nextAction: null },
                MGSO4: { obs: "Ù„Ø§ ÙŠØªÙƒÙˆÙ† Ø±Ø§Ø³Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ø±Ø¯.", effect: "none", nextAction: "HEAT" }
            },
            "NO2-": {
                name: "Ù†ØªØ±ÙŠØª", group: 1, ion: "NOâ‚‚â»",
                DIL_HCL: { obs: "ØªØµØ§Ø¹Ø¯ Ø£Ø¨Ø®Ø±Ø© Ø¨Ù†ÙŠØ© Ø¹Ù„Ù‰ ÙÙˆÙ‡Ø© Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨Ø©.", effect: "brown-fumes", nextAction: null },
                AGNO3: { obs: "Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶ (White ppt) âšª", effect: "white-ppt" }
            },
            "SO3--": {
                name: "ÙƒØ¨Ø±ÙŠØªÙŠØª", group: 1, ion: "SOâ‚ƒÂ²â»",
                DIL_HCL: { obs: "ØªØµØ§Ø¹Ø¯ ØºØ§Ø² SOâ‚‚.", effect: "1", nextAction: "K2CR2O7" },
                PBA: { obs: "Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶ (White ppt) âšª", effect: "white-ppt" }
            },
            "Cl-": {
                name: "ÙƒÙ„ÙˆØ±ÙŠØ¯", group: 2, ion: "Clâ»",
                DIL_HCL: { obs: "Ø³Ù„Ø¨ÙŠØ© (-ve)", effect: "none" },
                CONC_H2SO4: { obs: "ØªØµØ§Ø¹Ø¯ ØºØ§Ø² HCl.", effect: "1", nextAction: "AMMONIA" },
                PBA: { obs: "Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶ (White ppt) âšª", effect: "white-ppt" },
                AGNO3: { obs: "Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶ (White ppt) âšª", effect: "white-ppt" }
            },
            "I-": {
                name: "ÙŠÙˆØ¯ÙŠØ¯", group: 2, ion: "Iâ»",
                DIL_HCL: { obs: "Ø³Ù„Ø¨ÙŠØ© (-ve)", effect: "none" },
                CONC_H2SO4: { obs: "ØªØµØ§Ø¹Ø¯ Ø£Ø¨Ø®Ø±Ø© Ø¨Ù†ÙØ³Ø¬ÙŠØ© Ø¯Ø§ÙƒÙ†Ø© (Iâ‚‚) ğŸŸ£", effect: "violet-fumes", nextAction: null },
                PBA: { obs: "Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶ (White ppt) âšª", effect: "white-ppt" },
                AGNO3: { obs: "Ø±Ø§Ø³Ø¨ Ø£ØµÙØ± ğŸŸ¡", effect: "yellow-ppt" }
            },
            "SO4--": {
                name: "ÙƒØ¨Ø±ÙŠØªØ§Øª", group: 3, ion: "SOâ‚„Â²â»",
                DIL_HCL: { obs: "Ø³Ù„Ø¨ÙŠØ© (-ve)", effect: "none" },
                CONC_H2SO4: { obs: "Ø³Ù„Ø¨ÙŠØ© (-ve)", effect: "none" },
                BACL2: { obs: "ØªÙƒÙˆÙ† Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶.", effect: "white-ppt", nextAction: "SOLUBILITY" },
                AGNO3: { obs: "Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶ (White ppt) âšª", effect: "white-ppt" }
            },
            "PO4---": {
                name: "ÙÙˆØ³ÙØ§Øª", group: 3, ion: "POâ‚„Â³â»",
                DIL_HCL: { obs: "Ø³Ù„Ø¨ÙŠØ© (-ve)", effect: "none" },
                CONC_H2SO4: { obs: "Ø³Ù„Ø¨ÙŠØ© (-ve)", effect: "none" },
                BACL2: { obs: "ØªÙƒÙˆÙ† Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶.", effect: "white-ppt", nextAction: "SOLUBILITY" },
                AGNO3: { obs: "Ø±Ø§Ø³Ø¨ Ø£ØµÙØ± ğŸŸ¡", effect: "yellow-ppt" }
            }
        };

        const SALTS_ARRAY = Object.keys(SALTS);
        let currentSaltKey = null;
        let log = [];
        let isPptPresent = false;
        let isTestActive = false; // New state to enforce procedural flow

        const elements = {
            status: document.getElementById('salt-status'),
            tube: document.getElementById('test-tube'),
            tubeContents: document.getElementById('salt-contents'),
            log: document.getElementById('observation-log'),
            guessSelect: document.getElementById('salt-guess'),
            guessBtn: document.getElementById('guess-btn'),
            guessResult: document.getElementById('guess-result'),
            reagentBtns: document.querySelectorAll('.reagent-btn'),
            resetTubeBtn: document.getElementById('reset-tube-btn'),
            actionBtns: {
                K2CR2O7: document.getElementById('action-k2cr2o7'),
                AMMONIA: document.getElementById('action-ammonia'),
                SOLUBILITY: document.getElementById('action-solubility'),
                HEAT: document.getElementById('action-heat')
            }
        };
        
        function disableAllActions() {
            Object.values(elements.actionBtns).forEach(btn => btn.disabled = true);
        }

        function disableAllReagents() {
            elements.reagentBtns.forEach(btn => btn.disabled = true);
        }

        function enableAllReagents() {
            elements.reagentBtns.forEach(btn => btn.disabled = false);
        }

        function clearVisuals() {
            elements.tubeContents.className = 'bg-gray-200';
            elements.tubeContents.innerHTML = '';
            elements.tube.classList.remove('fumes-active', 'cloud-active');
            isPptPresent = false;
        }

        function startNewGame() {
            //currentSaltKey = SALTS_ARRAY[Math.floor(Math.random() * SALTS_ARRAY.length)];
            currentSaltKey = SALTS_ARRAY[4];
			log.length = 0; 
            isTestActive = false;
            
            clearVisuals();
            disableAllActions();
            enableAllReagents();

            elements.status.innerHTML = 'Ù…Ù„Ø­ ØµÙ„Ø¨ Ù…Ø¬Ù‡ÙˆÙ„ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±.';
            elements.log.innerHTML = '<p class="text-gray-400 text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¨Ø¹Ø¯.</p>';
            elements.guessBtn.disabled = false;
            elements.guessResult.classList.add('hidden');
            
            elements.guessSelect.innerHTML = '<option value="">-- Ø§Ø®ØªØ± ØªØ®Ù…ÙŠÙ†Ùƒ --</option>';
            const shuffledSalts = [...SALTS_ARRAY].sort(() => Math.random() - 0.5);
            shuffledSalts.forEach(key => {
                const option = document.createElement('option');
                option.value = key; // Use the salt key (e.g., "CO3--") as the value
                option.textContent = SALTS[key].name + ' (' + SALTS[key].ion + ')';
                elements.guessSelect.appendChild(option);
            });
        }

        // Function to reset only the tube visuals and actions (keeping the salt and log)
        function resetTube() {
            clearVisuals();
            disableAllActions();
            enableAllReagents();
            isTestActive = false;
            elements.status.innerHTML = 'Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨Ø© Ù†Ø¸ÙŠÙØ©. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ§Ø´Ù.';
        }

        function getReaction(saltKey, reagentKey) {
            const salt = SALTS[saltKey];
            let reaction = salt[reagentKey];

            if (reaction) return reaction;

            // Default negative result logic
            const saltGroup = salt.group;
            let obsText = "Ø³Ù„Ø¨ÙŠØ© (-ve)";

            if (reagentKey === 'DIL_HCL' && saltGroup > 1) {
                obsText = "Ø³Ù„Ø¨ÙŠØ© (-ve). Ù„Ø§ ÙŠÙ†ØªÙ…ÙŠ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰.";
            } else if (reagentKey === 'CONC_H2SO4' && saltGroup > 2) {
                obsText = "Ø³Ù„Ø¨ÙŠØ© (-ve). Ù„Ø§ ÙŠÙ†ØªÙ…ÙŠ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©.";
            } else if (reagentKey === 'BACL2' && saltGroup < 3) {
                obsText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ§Ø¹Ù„ Ù…Ù…ÙŠØ².";
            } else if (REAGENTS[reagentKey].type === 'confirmatory') {
                obsText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ§Ø¹Ù„ Ù…Ù…ÙŠØ² Ø£Ùˆ Ù†ØªÙŠØ¬Ø© Ø³Ù„Ø¨ÙŠØ© (-ve)";
            }
            
            return { obs: obsText, effect: "none" };
        }

        function applyVisualEffect(effect) {
            elements.tubeContents.classList.remove('fizzing', 'brown-fumes', 'violet-fumes', 'green-ppt', 'orange-ppt');
            elements.tubeContents.classList.add('bg-gray-200');

            if (effect === 'none') {
                return;
            }
            
            elements.tubeContents.classList.add(effect);

            // Gases/Fumes
            if (effect.includes('fumes')) {
                 elements.tubeContents.style.height = '100%';
            }
            
            // Solution color change
            if (effect.includes('solution')) {
                 elements.tubeContents.style.height = '100%';
            }

            // Precipitates
            if (effect.includes('ppt')) {
                if (!isPptPresent) {
                    const pptLayer = document.createElement('div');
                    pptLayer.className = `ppt ${effect}`;
                    elements.tubeContents.appendChild(pptLayer);
                    isPptPresent = true;
                }
            }
        }
        
        function logObservation(reagentName, observationText, logType) {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${logType}`;
            logItem.innerHTML = `<b>${reagentName}:</b> ${observationText}`;
            
            if (log.length === 0) {
                elements.log.innerHTML = '';
            }
            elements.log.prepend(logItem); 
            log.push({ reagent: reagentName, result: observationText });
            elements.log.scrollTop = 0;
        }

        // --- Core Reagent Click Handler ---
        elements.reagentBtns.forEach(btn => {
            btn.addEventListener('click', (event) => {
                if (isTestActive) return; // Prevent new test without reset
                
                const reagentKey = event.target.dataset.reagentKey;
                const reagentName = REAGENTS[reagentKey].name;
                const reaction = getReaction(currentSaltKey, reagentKey);
                
                // Set procedural state
                isTestActive = true; 
                disableAllReagents(); // Disable reagents after first test
                
                // Clear previous visuals and reset actions
                clearVisuals();
                disableAllActions();
                
                // Show visual effect
                applyVisualEffect(reaction.effect);

                // Determine log type and update status
                const isPositive = !reaction.obs.includes("Ø³Ù„Ø¨ÙŠØ© (-ve)") && reaction.effect !== 'none';
                const logType = isPositive ? 'log-positive' : 'log-negative';
                elements.status.innerHTML = isPositive ? 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©. Ø§Ù†Ø¸Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù†Ø¨ÙˆØ¨.' : 'Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø³Ù„Ø¨ÙŠØ©. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø£Ùˆ Ø®Ù…Ù†.';

                // Log observation (bypasses direct observation for complex tests like SO3-- and Cl-)
                let finalObs = reaction.obs;
                if (reaction.nextAction) {
                    // For complex tests, log only the primary observation
                     if (reagentKey === 'DIL_HCL' && currentSaltKey === 'SO3--') {
                        finalObs = 'ØªØµØ§Ø¹Ø¯ ØºØ§Ø² SOâ‚‚. ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ÙƒØ§Ø´Ù Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ØªØ£ÙƒÙŠØ¯.';
                    } else if (reagentKey === 'CONC_H2SO4' && currentSaltKey === 'Cl-') {
                        finalObs = 'ØªØµØ§Ø¹Ø¯ ØºØ§Ø² HCl. ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ¹Ø±ÙŠØ¶ Ù„Ù„Ø£Ù…ÙˆÙ†ÙŠØ§ Ù„Ù„ØªØ£ÙƒÙŠØ¯.';
                    }
                }
                logObservation(reagentName, finalObs, logType);
                
                // Enable next specific action if defined in SALTS data
                if (reaction.nextAction) {
                    const nextActionBtn = elements.actionBtns[reaction.nextAction];
                    if (nextActionBtn) nextActionBtn.disabled = false;
                }

                // Special handling for BaCl2 ppt to enable solubility test immediately
                if (reagentKey === 'BACL2' && (currentSaltKey === 'SO4--' || currentSaltKey === 'PO4---')) {
                    elements.actionBtns.SOLUBILITY.disabled = false;
                }
                
                // Special handling for MgSO4 non-ppt to enable heat action (for HCO3-)
                if (reagentKey === 'MGSO4' && currentSaltKey === 'HCO3-') {
                    elements.actionBtns.HEAT.disabled = false;
                }

                elements.guessBtn.disabled = false;
            });
        });

        // --- Action Buttons Handlers (K2Cr2O7, Ammonia, Solubility, Heat) ---

        // K2Cr2O7 (Confirmatory for SO3--)
        elements.actionBtns.K2CR2O7.addEventListener('click', () => {
            disableAllActions();
            const reagentName = "Ø«Ø§Ù†ÙŠ ÙƒØ±ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ… (Kâ‚‚Crâ‚‚Oâ‚‡)";
            let obsText;

            if (currentSaltKey === 'SO3--') {
                // Visual sequence: Orange -> Green (slow transition)
                elements.tubeContents.classList.add('orange-ppt');
                elements.status.innerHTML = 'ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ÙƒØ§Ø´Ù Ø«Ø§Ù†ÙŠ ÙƒØ±ÙˆÙ…Ø§Øª Ø§Ù„Ø¨ÙˆØªØ§Ø³ÙŠÙˆÙ…...';
                
                setTimeout(() => {
                    // Start slow transition
                    elements.tubeContents.classList.remove('orange-ppt');
                    elements.tubeContents.classList.add('green-ppt');
                    obsText = "ØªØºÙŠØ± Ù„ÙˆÙ† Ø§Ù„Ù…Ø­Ù„ÙˆÙ„ Ù…Ù† Ø§Ù„Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ø¥Ù„Ù‰ <b>Ø§Ù„Ø£Ø®Ø¶Ø±</b>.";
                    logObservation(reagentName, obsText, 'log-positive');
                    elements.status.innerHTML = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ÙŠØ©.';
                }, 2000); // Wait 1 second before turning green (simulating reaction time)
            } else {
                obsText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ù„ÙˆÙ†. Ù†ØªÙŠØ¬Ø© Ø³Ù„Ø¨ÙŠØ©.";
                logObservation(reagentName, obsText, 'log-negative');
                elements.status.innerHTML = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ÙŠØ©.';
            }
        });

        // Ammonia (Confirmatory for Cl-)
        elements.actionBtns.AMMONIA.addEventListener('click', () => {
            disableAllActions();
            const reagentName = "ØªØ¹Ø±ÙŠØ¶ Ù„Ø³Ø§Ù‚ Ø§Ù„Ø£Ù…ÙˆÙ†ÙŠØ§";
            let obsText;

            if (currentSaltKey === 'Cl-') {
                // Insert cloud visual
                applyVisualEffect('ammonia-cloud');
				obsText = "ØªÙƒÙˆÙ† <b>Ø³Ø­Ø¨ Ø¨ÙŠØ¶Ø§Ø¡</b> ÙƒØ«ÙŠÙØ©.";
                logObservation(reagentName, obsText, 'log-positive');
                // Remove cloud after logging (realism: cloud dissipates)
                setTimeout(() => {
                    const cloud = document.getElementById('ammonia-cloud');
                    if (cloud) cloud.remove();
                }, 1500);
            } else {
                obsText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø­Ø¨ Ø¨ÙŠØ¶Ø§Ø¡. Ù†ØªÙŠØ¬Ø© Ø³Ù„Ø¨ÙŠØ©.";
                logObservation(reagentName, obsText, 'log-negative');
            }
            elements.status.innerHTML = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ÙŠØ©.';
        });

        // Heat (Confirmatory for HCO3-)
        elements.actionBtns.HEAT.addEventListener('click', () => {
            disableAllActions();
            const reagentName = "ØªØ³Ø®ÙŠÙ†/ØºÙ„ÙŠ Ø§Ù„Ù…Ø­Ù„ÙˆÙ„";
            let obsText;

            if (currentSaltKey === 'HCO3-') {
                applyVisualEffect('white-ppt');
                obsText = "ØªÙƒÙˆÙ† <b>Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶</b> Ø¨Ø¹Ø¯ Ø§Ù„ØªØ³Ø®ÙŠÙ†.";
                logObservation(reagentName, obsText, 'log-positive');
            } else if (currentSaltKey === 'CO3--') {
                obsText = "Ø±Ø§Ø³Ø¨ Ø£Ø¨ÙŠØ¶ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙˆÙ„Ù… ÙŠØªØºÙŠØ±.";
                logObservation(reagentName, obsText, 'log-negative');
            } else {
                obsText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØºÙŠÙŠØ± Ù…Ù„Ø­ÙˆØ¸. Ù†ØªÙŠØ¬Ø© Ø³Ù„Ø¨ÙŠØ©.";
                logObservation(reagentName, obsText, 'log-negative');
            }
            elements.status.innerHTML = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ÙŠØ©.';
        });

        // Solubility Test (SO4-- vs PO4---)
        elements.actionBtns.SOLUBILITY.addEventListener('click', () => {
            elements.actionBtns.SOLUBILITY.disabled = true;
            const reagentName = "Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°ÙˆØ¨Ø§Ù†ÙŠØ© ÙÙŠ dil HCl";
            const pptLayer = elements.tubeContents.querySelector('.ppt');
            let obsText;

            if (currentSaltKey === 'PO4---') {
                if (pptLayer) pptLayer.classList.add('dissolved');
                isPptPresent = false; // The ppt is gone
                obsText = "Ø§Ù„Ø±Ø§Ø³Ø¨ Ø§Ù„Ø£Ø¨ÙŠØ¶ <b>Ø°Ø§Ø¨</b> ÙÙŠ dil HCl.";
                logObservation(reagentName, obsText, 'log-positive');
            } else if (currentSaltKey === 'SO4--') {
                if (pptLayer) pptLayer.classList.remove('dissolved');
                obsText = "Ø§Ù„Ø±Ø§Ø³Ø¨ Ø§Ù„Ø£Ø¨ÙŠØ¶ <b>Ù„Ù… ÙŠØ°Ø¨</b> ÙÙŠ dil HCl.";
                logObservation(reagentName, obsText, 'log-positive');
            } else {
                obsText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø³Ø¨ Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø°ÙˆØ¨Ø§Ù†ÙŠØ©. Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ù„Ø³Ù„.";
                logObservation(reagentName, obsText, 'log-negative');
            }
            elements.status.innerHTML = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„Ù„Ø±Ø§Ø³Ø¨.';
        });

        function handleGuess() {
            const userGuessKey = elements.guessSelect.value;
            const correctSalt = SALTS[currentSaltKey];
            
            elements.guessResult.classList.remove('hidden');
            
            if (userGuessKey === currentSaltKey) { // FIX: Compare userGuessKey (e.g., "CO3--") to currentSaltKey (e.g., "CO3--")
                elements.guessResult.className = 'mt-3 p-3 text-center rounded-md font-bold bg-green-600 text-white';
                elements.guessResult.textContent = `ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©. Ø§Ù„Ù…Ù„Ø­ Ù‡Ùˆ ${correctSalt.name} (${correctSalt.ion}).`;
                elements.reagentBtns.forEach(btn => btn.disabled = true);
                disableAllActions();
                elements.guessBtn.disabled = true;
                elements.status.innerHTML = 'ØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ù…Ù„Ø­ Ø¨Ù†Ø¬Ø§Ø­.';
            } else {
                elements.guessResult.className = 'mt-3 p-3 text-center rounded-md font-bold bg-red-600 text-white';
                elements.guessResult.textContent = `âŒ ØªØ®Ù…ÙŠÙ† Ø®Ø§Ø·Ø¦. Ø§Ù„Ù…Ù„Ø­ Ø§Ù„ØµØ­ÙŠØ­ ÙƒØ§Ù†: ${correctSalt.name} (${correctSalt.ion}).`; // Show the correct answer
                elements.reagentBtns.forEach(btn => btn.disabled = true);
                disableAllActions();
                elements.guessBtn.disabled = true;
                elements.status.innerHTML = 'Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©. Ø£Ø¹Ø¯ Ø§Ù„Ø¨Ø¯Ø¡ Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.';
            }
        }

        // Attach listeners
        document.getElementById('reset-btn').addEventListener('click', startNewGame);
        document.getElementById('reset-tube-btn').addEventListener('click', resetTube);
        elements.guessBtn.addEventListener('click', handleGuess);
        
        // Initialize the game
        startNewGame();
    </script>

</body>
</html>
